# 監視機能付き自作オンライン対戦ゲームサーバの構築

## 1. 目的と完成条件の定義

### 目的
Windows 11 Home 環境および Docker Desktop を基盤として、自作のPython製レーシングゲーム「otetekart」のマルチプレイ用サーバを構築する。
本プロジェクトでは、リアルタイムな座標同期とレース状態管理を行う**ゲームサーバ**と、その稼働状況を常時監視する**Uptime Kuma**を連携させ、安定した対戦環境を提供することを目的とする。

### 完成条件
1.  **通信の確立**: ホスト側のポート `5000` でゲームサーバが TCP 接続を受け付けていること。
2.  **監視の正常化**: Uptime Kuma（ポート `3001`）のダッシュボード上で、ゲームサーバのステータスが「正常」と表示されること。
3.  **対戦の実証**: 2つ以上のクライアント（`main.py`）から接続し、レース状態（WAITING → RACING）の遷移および座標同期が正常に行われること。

---

## 2. 全体構成図とポート設計

### システム構成
Windows ホスト上の Docker Desktop にて、Docker Compose を用いたマルチコンテナ構成を採用する。

-   **Container 1: otetekart-server**
    -   役割: ゲームロジック処理、座標ブロードキャスト（Python 3.11）
-   **Container 2: uptime-kuma**
    -   役割: サービス監視、稼働ログの可視化

### ポート設計
| サービス名 | コンテナポート | ホストポート | プロトコル | 用途 |
| :--- | :--- | :--- | :--- | :--- |
| otetekart-server | 5000 | **5000** | TCP | ゲームクライアントとの通信 |
| uptime-kuma | 3001 | **3001** | TCP (HTTP) | 監視ダッシュボードへのアクセス |

---

## 3. 事前準備

本手順は、Windows 11 Home に Python や Docker がインストールされていない状態からの構築を想定している。

### 3.1 実行環境のセットアップ

#### 1. Python 3.11.9 のインストール
クライアント（ゲーム本体）を動かすために必要となる。

1.  Webブラウザで [Python 公式ダウンロードページ](https://www.python.org/downloads/release/python-3119/) にアクセスする。
2.  **"Windows installer (64-bit)"** をダウンロードする。
3.  インストーラーを起動し、**必ず "Add python.exe to PATH"（PATHを通す）にチェックを入れてから** "Install Now" をクリックする。
4.  **確認コマンド**: PowerShellを開き、以下を実行する。
    ```powershell
    python --version
    ```
    *   **成功**: `Python 3.11.9` と表示される。
    *   **失敗**: 「用語 'python' は認識されていません」等のエラーが出る場合、インストール時の "Add to PATH" 忘れが原因。再インストールするか環境変数を設定する。

#### 2. Docker Desktop のインストール
サーバコンテナを動かすために必要となる。

1.  Webブラウザで [Docker Desktop 公式ページ](https://docs.docker.com/desktop/install/windows-install/) にアクセスし、インストーラーをダウンロードする。
2.  インストーラーを起動し、画面の指示に従う（"Use WSL 2 instead of Hyper-V" はチェックを入れたままにする）。
3.  インストール完了後、Windowsを再起動する。
4.  **重要**: 再起動後、スタートメニューから **Docker Desktop アプリを起動する**（初回は利用規約への同意が必要）。
5.  **確認コマンド**:
    ```powershell
    docker --version
    ```
    *   **成功**: `Docker version 2x.x.x...` のようにバージョンが表示される。
    *   **失敗**: エラーが出る場合、Docker Desktop アプリが起動していない可能性がある。

### 3.2 プロジェクトの取得 (git clone)

GitHubリポジトリから、ゲームプログラムおよびサーバ設定ファイル一式を取得する。

1.  任意の作業フォルダ（例: `Documents`）でPowerShellを開く。
2.  以下のコマンドを実行する。
    ```powershell
    # リポジトリのURL（適宜書き換えてください）
    git clone https://github.com/kai-1208/otetekart_in_python.git
    
    # プロジェクトディレクトリへ移動
    cd otetekart_in_python
    ```
    *   **成功**: ディレクトリ内に `main.py` や `docker-compose.yml` がダウンロードされる。
    *   **失敗**: Gitがインストールされていない場合は、[Git for Windows](https://gitforwindows.org/) をインストールするか、[GitHubのリポジトリ](https://github.com/kai-1208/otetekart_in_python)から「Download ZIP」でダウンロードして解凍する。

### 3.3 依存ライブラリのインストール

クライアント環境に必要なライブラリをインストールする。本プロジェクトでは高速化のために `Numba` を使用している。

```powershell
pip install -r requirements.txt
```

**`requirements.txt` の内容:**
```text
pygame==2.6.1
numpy==2.1.2
numba==0.61.2
```
*   **成功**: すべてのパッケージが `Successfully installed...` と表示される。
*   **失敗**: `Microsoft Visual C++ 14.0 is required` 等のエラーが出る場合、Visual Studio Build Tools のインストールが必要になる場合がある。

---

## 4. 構築手順

本プロジェクトでは `git clone` により設定ファイル一式が手元にある状態だが、構築内容の理解のため、主要な設定ファイルの内容について解説する。

### 4.1 設定ファイルの解説

**1. `server/Dockerfile` （ゲームサーバ定義）**
```dockerfile
# ベースイメージとして、軽量な Python 3.11 (Slim版) を使用する
FROM python:3.11-slim

# コンテナ内での作業ディレクトリを /app に設定する
WORKDIR /app

# Python の出力（ログ）をバッファリングせず、即座にコンソールに出力させる設定
ENV PYTHONUNBUFFERED=1

# 依存ライブラリは標準ライブラリのみのため、ソースコード(server.py)のみをコンテナにコピーする
COPY server.py .

# コンテナが外部に向けて TCP 5000 番ポートを使用することを宣言する
EXPOSE 5000

# コンテナ起動時に実行するコマンド（サーバープログラムの開始）を指定する
CMD ["python", "server.py"]
```

**2. `docker-compose.yml` （構成定義）**
```yaml
version: '3.8'

services:
  # --- サービス1: ゲームサーバ ---
  otetekart-server:
    # ./server ディレクトリにある Dockerfile を基にビルドを行う
    build: ./server
    # ホスト側のポート5000を、コンテナ側のポート5000に転送する
    ports:
      - "5000:5000"
    # エラーなどで停止した場合、常に自動で再起動するように設定する
    restart: always

  # --- サービス2: 監視システム (Uptime Kuma) ---
  uptime-kuma:
    # Docker Hub 公式の Uptime Kuma イメージを使用する
    image: louislam/uptime-kuma:1
    restart: always
    # Web管理画面用にポート3001を開放する
    ports:
      - "3001:3001"
    # 監視設定や履歴データが消えないよう、ボリューム(永続化領域)に保存する
    volumes:
      - uptime-kuma-data:/app/data

# データの永続化に使用する名前付きボリュームを定義する
volumes:
  uptime-kuma-data:
```

### 4.2 サービスの起動

**前提**: Docker Desktop アプリが起動しており、左下のステータスが緑色（Engine running）になっていること。

PowerShellでプロジェクトルート（`otetekart_in_python/`）にいることを確認し、実行する。

```powershell
docker-compose up -d --build
```
-   `--build`: イメージのビルドを強制する。
-   `-d`: バックグラウンドモードで実行する。

**実行結果の確認:**
*   **成功**:
    ```text
    [+] Running 3/3etekart_in_python-uptime-
    ✔ otetekart_in_python-otetekart-server              Built0.0s in_python-oteteka       
    ✔ Container otetekart_in_python-uptime-kuma-1       Running0.0s
    ✔ Container otetekart_in_python-otetekart-server-1  Started1.9s
    ```
    と表示されれば成功である。
*   **失敗例と対処**:
    *   `error during connect`: Docker Desktop が起動していない。アプリを起動する。
    *   `Ports are not available`: ポート5000または3001を他のアプリが使用している。使用中のアプリを終了するか、`docker-compose.yml` のポート番号を変更する。

---

## 5. 動作確認と検証

### 5.1 監視システムの導入

1.  **アクセス**: ブラウザで `http://localhost:3001` を開く。
2.  **アカウント作成**: 管理者用のユーザー名・パスワードを設定して作成する。
3.  **モニターの追加**:
    -   ダッシュボード左上の **[+ 監視の追加]** をクリック。
    -   以下の通り設定する。
        -   **監視タイプ**: `TCP Port`
        -   **分かりやすい名前**: `otetekart`
        -   **ホスト名**: `otetekart-server` (Docker内でのサービス名)
        -   **ポート**: `5000`
        -   **監視間隔**: `60`
    -   下の **[保存]** をクリック。

    ![Uptime Kuma設定画面](./docs/images/uptimekuma_setup.png)
    *(ここに設定画面のスクリーンショットを配置)*

4.  **稼働確認**:
    -   ステータスが緑色の **[正常]** になることを確認する。

    ![Uptime Kumaダッシュボード](./docs/images/uptimekuma_dashboard.png)
    *(ここに緑色になったダッシュボードのスクリーンショットを配置)*

### 5.2 クライアント接続とゲームロジック検証

PowerShellを2つ開き、それぞれで以下を実行して2台分のクライアントを立ち上げる。

```powershell
python main.py
```

**確認すべきログと動作:**
1.  **接続成功時**:
    -   クライアント側のコンソールに `Connected to server at localhost:5000` や `My Client ID: User_xxxxxx` と表示される。
    -   **エラー**: `ConnectionRefusedError` が出る場合は、Dockerコンテナが起動していないか、ファイアウォールでブロックされている可能性がある。
2.  **ゲームプレイ**:
    -   メインメニューで「VS Race」を選択し、キャラクターを選んだ後、ルーム（例: Room 0）に入る。
    -   両方の画面で、互いのキャラクターが表示される。
    -   移動すると、もう一方の画面でもリアルタイムに位置が変わる。

---

## 6. トラブルシューティング

### 6.1 Uptime Kuma からサーバが見つからない (DOWN状態)
-   **原因**: ホスト名に localhost や 127.0.0.1 を指定している。
-   **対策**: Uptime Kuma コンテナから見た `localhost` は自分自身を指すため、接続できない。Docker Compose のサービス名である `otetekart-server` をホスト名に指定する。

### 6.2 クライアントが接続できない
-   **原因**: Windows ファイアウォールによってブロックされている。
-   **対策**: 初回起動時に表示されるファイアウォールの警告で「アクセスを許可する」を選択する。または、PowerShellで以下のコマンドを実行し、`TcpTestSucceeded : True` となるか確認する。
```powershell
Test-NetConnection localhost -Port 5000
```


### 6.3 コンテナが起動しない
-   **原因**: 過去に起動したコンテナが正常に終了せずに残っている、または古いネットワークやボリュームの設定が衝突している可能性がある。
-   **対処**:
    1.  PowerShellで以下のコマンドを実行し、一度削除する。
    ```powershell
    docker-compose down
    ```
    2.  以下のコマンドを実行し、古いキャッシュを消す。
    ```powershell
    docker system prune
    ```
    3.  再度以下のコマンドを実行する。
    ```powershell
    docker-compose up -d
    ```

### 6.4 Uptime Kumaのユーザ名またはパスワードを忘れた場合
-   **対処**: PowerShellで以下のコマンドを実行することで、コンテナ内部のCLIツールからパスワードの再設定が可能である。

```powershell
docker exec -it uptime-kuma npm run reset-password
```

---

## 7. セキュリティ配慮

-   **Docker Internal Network の活用**:
    Uptime Kuma による監視通信は、Docker の内部ネットワーク経由で行われるため、外部ネットワーク（インターネット等）に監視用パケットが流出しない設計となっている。
-   **データの永続化**:
    Uptime Kuma の設定データは `volumes` を用いてホスト側から分離して管理しており、コンテナの再起動や再構築を行っても監視設定や履歴が消失しない。

---

## 8. 参考資料
-   [Python 3.11.9 Download](https://www.python.org/downloads/release/python-3119/)
-   [Docker Desktop for Windows](https://docs.docker.com/desktop/windows/)
-   [Uptime Kuma Wiki](https://github.com/louislam/uptime-kuma/wiki)