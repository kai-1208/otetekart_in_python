# 監視機能付き自作オンライン対戦ゲームサーバの構築

## 1. 目的と完成条件の定義

### 目的
Windows 11 Home 環境および Docker Desktop を基盤として、自作のPython製レーシングゲーム「otetekart」のマルチプレイ用サーバを構築する。
本環境では、リアルタイムな座標同期とレース状態管理を行う**ゲームサーバ**と、その稼働状況を常時監視する**Uptime Kuma**を連携させ、安定した対戦環境を提供することを目的とする。

### 完成条件
1.  **通信の確立**: ホスト側のポート `5000` でゲームサーバが TCP 接続を受け付けていること。
2.  **監視の正常化**: Uptime Kuma（ポート `3001`）のダッシュボード上で、ゲームサーバのステータスが「正常」と表示されること。
3.  **対戦の実証**: 2つ以上のクライアント（`main.py`）から接続し、レース状態（WAITING → RACING）の遷移および座標同期が正常に行われること。

---

## 2. 全体構成図とポート設計

### システム構成
Windows ホスト上の Docker Desktop にて、Docker Compose を用いたマルチコンテナ構成を採用する。

-   **Container 1: otetekart-server**
    -   役割: ゲームロジック処理、座標ブロードキャスト（Python 3.11）
-   **Container 2: uptime-kuma**
    -   役割: サービス監視、稼働ログの可視化

### ポート設計
| サービス名 | コンテナポート | ホストポート | プロトコル | 用途 |
| :--- | :--- | :--- | :--- | :--- |
| otetekart-server | 5000 | **5000** | TCP | ゲームクライアントとの通信 |
| uptime-kuma | 3001 | **3001** | TCP (HTTP) | 監視ダッシュボードへのアクセス |

---

## 3. 事前準備

### 実行環境
本プロジェクトは、開発から動作検証までの一連の工程を以下の環境で実施した。

-   **OS**: Windows 11 Home
-   **コンテナランタイム**: Docker Desktop for Windows
-   **クライアント実行環境**: Python 3.11.9

### 必要なライブラリとインストール手順
クライアント（ゲーム本体）の実行には、描画エンジンの `Pygame`、数値計算用の `NumPy` に加え、計算処理を高速化するための **`Numba`** が必須である。これらは同梱の `requirements.txt` を用いて一括インストールを行う。

**インストールコマンド（PowerShell または コマンドプロンプト）:**

```powershell
# プロジェクトのルートディレクトリで実行
pip install -r requirements.txt
```

**requirements.txt の内容例:**
```text
pygame==2.6.1
numpy==2.1.2
numba==0.61.2
```

### ネットワーク設定
Windows Defender ファイアウォールにて、以下の通信を許可する設定を行う（ローカルテスト時は「許可されたアプリ」にDocker Desktopを含める）。
-   TCP ポート `5000`（ゲーム通信用）
-   TCP ポート `3001`（監視ダッシュボード用）


---

## 4. 構築手順

### 4.1 プロジェクトディレクトリの配置
技術仕様書に基づき、以下のディレクトリ構成を配置する。

```text
otetekart_in_python/
├── docker-compose.yml
├── server/
│   ├── Dockerfile
│   └── server.py
└── (その他クライアント用ファイル: main.py, src/ 等)
```
※ ソースコード一式は GitHub リポジトリより `git clone` するか、所定のフォルダに配置する。

### 4.2 Docker 設定ファイルの作成
仕様書に基づき、サーバ構築に必要な設定ファイルを配置する。

**1. `server/Dockerfile` の作成**
ゲームサーバのビルド定義を行う。軽量化のため `python:3.11-slim` を使用する。

```dockerfile
# ベースイメージとして、軽量な Python 3.11 (Slim版) を使用する
FROM python:3.11-slim

# コンテナ内での作業ディレクトリを /app に設定する
WORKDIR /app

# Python の出力（ログ）をバッファリングせず、即座にコンソールに出力させる設定
# (これにより、Docker logs でリアルタイムにログを確認できるようになる)
ENV PYTHONUNBUFFERED=1

# 依存ライブラリは標準ライブラリのみのため、ソースコード(server.py)のみをコンテナにコピーする
COPY server.py .

# コンテナが外部に向けて TCP 5000 番ポートを使用することを宣言する
EXPOSE 5000

# コンテナ起動時に実行するコマンド（サーバープログラムの開始）を指定する
CMD ["python", "server.py"]
```

**2. `docker-compose.yml` の作成**
ゲームサーバと監視ツールを定義し、ネットワーク連携とデータの永続化を設定する。

```yaml
# Docker Compose のファイルフォーマットバージョン 3.8 を使用する
version: '3.8'

services:
  # --- サービス1: ゲームサーバ ---
  otetekart-server:
    # ./server ディレクトリにある Dockerfile を基にビルドを行う
    build: ./server
    # ホスト側のポート5000を、コンテナ側のポート5000に転送する
    ports:
      - "5000:5000"
    # エラーなどで停止した場合、常に自動で再起動するように設定する
    restart: always

  # --- サービス2: 監視システム (Uptime Kuma) ---
  uptime-kuma:
    # Docker Hub 公式の Uptime Kuma イメージ (バージョン1) を使用する
    image: louislam/uptime-kuma:1
    # 常に自動再起動する設定
    restart: always
    # ホスト側のポート3001を、コンテナ側のポート3001に転送する (Web管理画面用)
    ports:
      - "3001:3001"
    # 監視設定や履歴データが消えないよう、ボリューム(永続化領域)に保存する
    volumes:
      - uptime-kuma-data:/app/data

# データの永続化に使用する名前付きボリュームを定義する
volumes:
  uptime-kuma-data:
```

### 4.3 サービスの起動
PowerShell または ターミナルでプロジェクトルート（`otetekart_in_python/`）を開き、以下のコマンドを実行する。

```powershell
docker-compose up --build
```
-   `--build`: `server/Dockerfile` の変更を反映してイメージを再構築する。

---

## 5. 動作確認と検証

### 5.1 監視システムの導入（発展要素：例E）
1.  ブラウザで `http://localhost:3001` にアクセスする。
2.  管理者アカウント（ユーザー名・パスワード）を作成する。
3.  ダッシュボードにて **[新しいモニターを追加]** をクリックし、以下の設定を行う。
    -   **監視タイプ**: `TCP Port`
    -   **表示名**: `Otetekart Server`
    -   **ホスト名**: `otetekart-server`
        -   ※ Docker内部DNSにより、サービス名で解決される（仕様書 5-2 参照）。
    -   **ポート**: `5000`
    -   **監視間隔**: `60` (秒)
4.  保存後、ステータスが緑色の **[正常]** になることを確認する（**証拠スクリーンショット 1**）。

### 5.2 ゲームロジックの動作検証
クライアント側（`main.py`）を2つのターミナルからそれぞれ起動し、対戦テストを行う。

1.  **接続テスト**:
    -   クライアントA、Bを起動。
    -   ログに `welcome` メッセージと ID 割り当てが表示されることを確認。
2.  **ルーム同期テスト**:
    -   両者が「VSレース（ルーム0〜9）」を選択。
    -   片方が `join` した際、サーバから `room_counts` が配信されることを確認。
3.  **レース状態遷移テスト**:
    -   両者が `Ready` を完了。
    -   サーバの状態が `WAITING` → `COUNTDOWN` → `RACING` へ遷移することを確認。
4.  **座標同期テスト**:
    -   クライアントAが移動した際、クライアントBの画面上で「半透明のゴースト」としてAの動きが描画されることを確認（**証拠スクリーンショット 2**）。

---

## 6. トラブルシューティング

### 6.1 Uptime Kuma からサーバが見つからない (DOWN状態)
-   **原因**: ホスト名に `localhost` や `127.0.0.1` を指定している。
-   **対策**: Uptime Kuma コンテナから見た `localhost` は自分自身を指すため、接続できない。Docker Compose のサービス名である `otetekart-server` をホスト名に指定する。

### 6.2 クライアントが接続できない
-   **原因**: Windows ファイアウォールによるブロック。
-   **対策**: 初回起動時に表示されるファイアウォールの警告で「アクセスを許可する」を選択する。または、PowerShellで `Test-NetConnection localhost -Port 5000` を実行し、`TcpTestSucceeded : True` となるか確認する。

### 6.3 タイムアタックで順位がおかしい
-   **原因**: `server.py` のソートロジックの確認。
-   **対策**: 完走者は `time` 昇順、未完走者は `lap` 降順でソートされているかログを確認する。

### 6.4 Uptime Kumaのユーザー名またはパスワードを忘れてしまった
-   **対策**: 以下のコマンドを実行することで、コンテナ内部のCLIツールからパスワードの再設定が可能である。

```powershell
# プロジェクトのルートディレクトリで実行
docker exec -it uptime-kuma npm run reset-password
```
---

## 7. セキュリティと設計への配慮

-   **Docker Internal Network の活用**:
    Uptime Kuma による監視通信は、Docker の内部ネットワーク経由で行われるため、外部ネットワーク（インターネット等）に監視用パケットが流出しない設計となっている。
-   **データの永続化**:
    Uptime Kuma の設定データは `volumes` を用いてホスト側から分離して管理しており、コンテナの再起動や再構築を行っても監視設定や履歴が消失しない。
-   **最小権限の原則 (Dockerfile)**:
    `server.py` は標準ライブラリのみを使用しており、`root` 権限を必要とする追加パッケージのインストールを行わない軽量な構成としている。

---

## 8. 参考資料
-   [Docker Desktop for Windows Documentation](https://docs.docker.com/desktop/windows/)
-   [Uptime Kuma Wiki](https://github.com/louislam/uptime-kuma/wiki)